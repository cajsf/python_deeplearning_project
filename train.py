from ultralytics import YOLO
import torch
import sys

# ìœˆë„ìš°ì—ì„œ ë©€í‹°í”„ë¡œì„¸ì‹± ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ í•„ìˆ˜ êµ¬ë¬¸
if __name__ == '__main__':
    
    # ==========================================
    # 1. GPUê°€ ì˜ ì¡íˆëŠ”ì§€ í™•ì¸
    # ==========================================
    print(f"Python ë²„ì „: {sys.version}")
    if torch.cuda.is_available():
        print(f"ğŸ”¥ GPU ê°€ë™! ëª¨ë¸ëª…: {torch.cuda.get_device_name(0)}")
        device = 0
    else:
        print("âš ï¸ GPUë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CPUë¡œ í•™ìŠµí•˜ë©´ ë©°ì¹ ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        device = 'cpu'

    # ==========================================
    # 2. ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
    # ==========================================
    # yolov8n(nano) < yolov8s(small) < yolov8m(medium)
    # ìŒì‹ ì¢…ë¥˜ê°€ 574ê°œë¡œ ë§ì•„ì„œ 'small' ëª¨ë¸ì„ ì¶”ì²œí•©ë‹ˆë‹¤. (ì†ë„/ì„±ëŠ¥ ë°¸ëŸ°ìŠ¤í˜•)
    model = YOLO('yolov8s.pt') 

    # ==========================================
    # 3. í•™ìŠµ ì‹œì‘ (í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹ë¨)
    # ==========================================
    results = model.train(
        # ---------------- [ê¸°ë³¸ ì„¤ì •] ----------------
        data=r"D:\ë°ì´í„°ì…‹\YOLO\datasets\data.yaml",  # ì•„ê¹Œ ë§Œë“  ë°ì´í„°ì…‹ ê²½ë¡œ
        epochs=30,             # ìµœëŒ€ 100ë²ˆ ë°˜ë³µ (patience ë•Œë¬¸ì— ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŒ)0
        patience=5,            # ì„±ëŠ¥ì´ 15ë²ˆ ë™ì•ˆ ì•ˆ ì˜¤ë¥´ë©´ ì¡°ê¸° ì¢…ë£Œ (ì‹œê°„ ì ˆì•½)
        batch=16,               # ë©”ëª¨ë¦¬ ë¶€ì¡± ì—ëŸ¬(OOM)ë‚˜ë©´ 8ë¡œ ì¤„ì´ì„¸ìš”
        imgsz=640,              # ì´ë¯¸ì§€ í¬ê¸° (í‘œì¤€)
        device=device,          # GPU ì‚¬ìš©
        workers=4,              # ë°ì´í„° ë¡œë”© ì†ë„ (CPU ì½”ì–´ ìˆ˜ì— ë”°ë¼ ì¡°ì ˆ)
        cache=False,
        
        # ---------------- [í”„ë¡œì íŠ¸ ì„¤ì •] ----------------
        project='Food_Detection_Project', # ê²°ê³¼ ì €ì¥ë  í´ë” ì´ë¦„
        name='train_result_300sample',    # ì´ë²ˆ ì‹¤í—˜ì˜ ì´ë¦„
        exist_ok=True,                    # ë®ì–´ì“°ê¸° í—ˆìš©
        
        # ---------------- [ìŒì‹ íŠ¹í™” ì¦ê°• ê¸°ë²•] ----------------
        # ìŒì‹ ì‚¬ì§„ì€ íšŒì „, ìƒ‰ê° ë³€í™”ê°€ ë§ìœ¼ë¯€ë¡œ ì•„ë˜ ì˜µì…˜ì´ ë„ì›€ë©ë‹ˆë‹¤.
        hsv_h=0.015,    # ìƒ‰ì¡°(Hue) ë³€í™” (ì¡°ëª… ì°¨ì´ ëŒ€ì‘)
        hsv_s=0.7,      # ì±„ë„(Saturation) ë³€í™”
        hsv_v=0.4,      # ëª…ë„(Value) ë³€í™”
        degrees=10.0,   # íšŒì „ (+/- 10ë„)
        fliplr=0.5,     # ì¢Œìš° ë°˜ì „ (ìŒì‹ì€ ì¢Œìš° ë°”ë€Œì–´ë„ ìŒì‹ì´ë‹ˆê¹Œ OK)
        flipud=0.0,     # ìƒí•˜ ë°˜ì „ (ìŒì‹ì€ ë’¤ì§‘íˆë©´ ìŸì•„ì§€ë‹ˆê¹Œ 0)
        mosaic=1.0,     # ëª¨ìì´í¬ ê¸°ë²• (ì—¬ëŸ¬ ì‚¬ì§„ í•©ì³ì„œ í•™ìŠµ - ì‘ì€ ìŒì‹ íƒì§€ì— ì¢‹ìŒ)
        
        # ì¶œë ¥ ìƒì„¸ ì„¤ì •
        verbose=True
    )

    print("\nâœ… í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    print("ê²°ê³¼ íŒŒì¼(best.pt)ì€ 'Food_Detection_Project/train_result_300sample/weights' í´ë”ì— ìˆìŠµë‹ˆë‹¤.")